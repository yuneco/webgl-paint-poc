# 開発ガイドライン

## テストファイル配置規則

### 必須事項
- **テストケースは実装と同じフォルダに配置する**
- テストファイルの命名規則: `[実装ファイル名].test.ts`

### 例
```
src/
  webgl/
    context.ts
    context.test.ts        // ← このように同じフォルダに配置
  types/
    core.ts
    core.test.ts          // ← このように同じフォルダに配置
```

### ❌ 禁止パターン
```
src/
  test/                   // ← 別フォルダでのテスト配置は禁止
    context.test.ts
    core.test.ts
  webgl/
    context.ts
  types/
    core.ts
```

## 要求事項の遵守

### 絶対原則
- **ユーザーの許可なく要求事項を勝手に変更してはならない**
- 仕様書に記載された要求事項は必ず遵守する
- 変更が必要な場合は必ずユーザーに確認を取る

### 例外的な場合
- 明らかな技術的制約がある場合のみ、理由を説明してユーザーに相談する
- 自己判断での要求事項の変更・省略・追加は一切禁止

### 記録義務
- 要求事項の変更があった場合は、必ずドキュメントに記録する
- 変更理由とユーザーの承認を明記する

## ファイル構成変更の対応

現在の問題のあるテストファイル配置を修正する必要があります：

### 移動が必要なファイル
- `src/test/webgl.test.ts` → `src/webgl/context.test.ts`
- `src/test/types.test.ts` → `src/types/core.test.ts`
- `src/test/basic.test.ts` → 基本テストのため削除予定

### 次の作業
1. テストファイルを正しい場所に移動
2. import文の修正
3. vitest設定の確認
4. テスト実行の確認

## ユーザーインターフェース統合原則

### デモ・UI統合の基本方針
- **ルートのindex.htmlに統合する** - 別ファイルでデモを作成しない
- 個別のデモHTMLファイルは作成せず、メインUIに機能を統合
- ユーザーが要求した場合のみ、機能をメインUIに統合して提供

### 統合時の注意事項
- 既存のUI構造を尊重し、適切にセクション分けする
- 設定（色、モード等）は統一されたUIコントロールを使用
- 機能ボタンは設定に従って動作するように実装
- 不要な個別ファイルは作成後に削除する

### ❌ 禁止パターン
```
src/demo/newFeatureDemo.html    // ← 個別デモファイルの作成禁止
src/ui/separateInterface.html   // ← 分離したインターフェース禁止
```

### ✅ 推奨パターン  
```
index.html                      // ← メインUIに統合
  ├── 既存機能セクション
  ├── 新機能統合セクション      // ← ここに新機能を統合
  └── 統一された設定UI
```

## 品質保証・テスト戦略

### 統合テスト戦略
**背景**: 2025年1月の実装で、個々のコンポーネントは単体テストされているが、コンポーネント間の相互作用で問題が発生することが判明。

**必須要件**:
- 各機能について、実際のユーザー操作フローをシミュレートする統合テストを作成
- 異なるデバイス特性（筆圧対応/非対応、マウス/タッチ/ペン）での動作を検証
- コンポーネント間のデータフローを検証する
- エッジケース（筆圧0、中心点、境界値、undefined値等）を体系的にテスト

**実装場所**: `src/integration/` フォルダに統合テストを配置

### 数学的実装の検証プロセス
**背景**: 8軸対称の実装で反射変換と回転変換を混同し、重複が発生する問題が発生。

**必須要件**:
- 実装前に期待される数学的プロパティを明文化（一意性、対称性、保存則等）
- プロパティベースドテスト（Property-based testing）の導入
- 視覚的検証と数値的検証の両方を実施
- 複雑な数学的処理では中間結果をログ出力する仕組みを用意

### デバイス特性考慮の設計原則
**背景**: 筆圧非対応デバイスでの筆圧0問題、moveイベントフィルタリング問題が発生。

**必須要件**:
- `DeviceCapabilities` インターフェースを導入してデバイス特性を明示的にモデル化
- デバイス固有の処理を明示的に分離
- 各デバイスタイプでの動作確認を必須とする
- 筆圧0のデバイスでも可視化される設計にする

### 型安全性の向上
**背景**: `axisCount?: number` が undefined になる問題、戻り値型の不整合問題が発生。

**必須要件**:
- オプショナル型は最小限に抑制、必須パラメータは明示的に required にする
- 戻り値型の統一（配列 vs オブジェクトの不整合を防ぐ）
- TypeScript strict モードを活用
- 型定義の一貫性を保つ

### デバッグ支援機能
**背景**: 実行時の問題特定に時間がかかる問題が発生。

**必須要件**:
- 複雑な処理（対称変換、座標変換等）では debug モードでの詳細ログ出力
- 中間結果の可視化機能
- エラー時の状態ダンプ機能
- 開発時の問題切り分けを効率化する仕組み

## コミット時の注意事項
- ガイドライン違反がないかチェック
- 要求事項の変更がある場合は明記
- テストファイル配置の正確性を確認
- UI統合原則に従っているか確認
- 不要なデモファイルが残っていないかチェック
- **統合テストが適切に追加されているか確認**
- **デバイス特性考慮が適切か確認**
- **数学的実装の検証が十分か確認**