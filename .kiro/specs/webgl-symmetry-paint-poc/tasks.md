# Implementation Plan

- [x] 1. プロジェクト基盤と WebGL 初期化

  - [x] 1.1 Vitest ブラウザモードのセットアップ

    - Vitest、@vitest/browser、webdriverio の依存関係追加
    - vitest.config.ts でブラウザモード設定
    - 基本的なテストファイル構造作成とサンプルテスト実装
    - _Requirements: 7.1, 7.2_

    **達成条件:**

    - ✅ `npm test`で Vitest が実行される
    - ✅ ブラウザモードでテストが動作する
    - ✅ サンプルテストがパスする

  - [x] 1.2 WebGL 初期化と Canvas 設定

    - 既存 webgl-paint-poc プロジェクトの index.html に Canvas 要素追加
    - WebGL コンテキスト初期化関数とエラーハンドリング実装
    - WebGL 機能テスト（コンテキスト取得、シェーダーサポート確認）
    - _Requirements: 7.1, 7.2, 5.4_

    **達成条件:**

    - ✅ 1024x1024 の Canvas 要素がページに表示される
    - ✅ WebGL コンテキストがエラーなく取得できる
    - ✅ WebGL 機能テストがパスする
    - ✅ エラーハンドリングが適切に動作する

- [x] 2. 基本データ型とテスト用データの準備

  - [x] 2.1 コアデータ型の定義

    - StrokePoint, StrokeData, SymmetryConfig 等の TypeScript 型定義
    - ViewState, PerformanceState の型実装
    - _Requirements: 7.1, 2.2_

    **達成条件:**

    - ✅ 型定義がコンパイルエラーなく使用できる
    - ✅ 型安全性が保たれている
    - ✅ 型定義が要件を満たしている

  - [x] 2.2 テスト用固定ストロークデータの作成

    - 動作確認用の固定ストロークデータセット作成
    - 単純な図形（直線、円弧、複雑なパス）のサンプルデータ
    - 対称描画テスト用のデータパターン準備
    - _Requirements: 2.2, 2.3_

    **達成条件:**

    - ✅ 直線、円弧、複雑なパスのサンプルデータが定義されている
    - ✅ データが正しい StrokePoint 配列形式になっている
    - ✅ 対称描画テスト用パターンが準備されている
    - ✅ データの妥当性が確認できている

- [x] 3. WebGL 描画エンジンの実装（最小構成）

  - [x] 3.1 基本シェーダープログラムの作成

    - 最小限の頂点シェーダー：基本的な座標変換のみ
    - 最小限のフラグメントシェーダー：単色描画
    - シェーダーコンパイルとエラーハンドリング
    - シェーダーコンパイル成功/失敗のテスト（無効なシェーダーでのエラー処理確認）
    - _Requirements: 1.1, 1.3, 5.4_

    **達成条件:**

    - ✅ 頂点シェーダーが正常にコンパイルされる
    - ✅ フラグメントシェーダーが正常にコンパイルされる
    - ✅ シェーダープログラムがリンクされる
    - ✅ エラーハンドリングテストがパスする
    - ✅ 無効なシェーダーで適切にエラーが報告される

  - [x] 3.2 基本 WebGL バッファ管理

    - 静的頂点バッファの基本実装
    - 固定ストロークデータから WebGL 頂点データへの変換関数
    - 基本的なバッファ操作の実装
    - 頂点データ変換関数の正確性テスト（入力データと出力バッファの対応確認）
    - _Requirements: 1.2, 5.4_

    **達成条件:**

    - ✅ 頂点バッファが正常に作成される
    - ✅ ストロークデータ → 頂点データ変換が正確に動作する
    - ✅ バッファ操作テストがパスする
    - ✅ メモリリークが発生しない

  - [x] 3.3 基本描画関数の実装と動作確認

    - renderStrokes 関数：固定ストロークデータを WebGL で描画
    - 固定データでの描画テスト実行
    - 視覚的な描画結果の確認（手動テスト）
    - 描画関数の副作用なしテスト（同じ入力で一貫した描画結果）
    - _Requirements: 1.2, 1.3, 1.4_

    **達成条件:**

    - ✅ 固定ストロークデータが画面に描画される
    - ✅ 直線が直線として、円弧が円弧として正しく表示される
    - ✅ 描画結果が期待される図形と一致する
    - ✅ 同じ入力で一貫した描画結果が得られる
    - ✅ 単色での基本描画が正常に動作する

- [x] 4. 対称変換システムの実装と統合

  - [x] 4.1 対称変換の数学的実装

    - 8 軸放射対称の変換行列計算関数実装
    - 中心点を原点とした座標変換関数
    - 対称軸角度計算の純粋関数実装
    - 対称変換の数学的正確性テスト（既知の座標での変換結果検証）
    - _Requirements: 2.2, 2.3, 2.5_

    **達成条件:**

    - ✅ 8 軸対称の変換行列が数学的に正確である
    - ✅ 中心点(512,512)を基準とした変換が正しく動作する
    - ✅ 対称軸角度計算が正確である（45 度間隔で 8 軸）
    - ✅ 数学的正確性テストがパスする
    - ✅ 既知座標での変換結果が期待値と一致する

  - [x] 4.2 対称ストローク生成と描画統合

    - 単一ストロークポイントから対称ポイント配列生成関数
    - 対称変換されたストロークの描画エンジンへの統合
    - 固定データでの対称描画テスト実行
    - 対称ポイント生成の一貫性テスト（軸数変更時の動作確認）
    - _Requirements: 2.3, 2.4_

    **達成条件:**

    - ✅ 単一ストロークから 8 つの対称ストロークが生成される
    - ✅ 対称描画が視覚的に確認できる（8 軸対称パターン）
    - ✅ 固定データでの対称描画テストがパスする
    - ✅ 対称パターンが数学的に正確である
    - ✅ 軸数変更時の動作が正しい

- [x] 5. 軽量ステート管理の導入

  - ✅ Zustand ライブラリの導入と設定
  - ✅ アプリケーションステートストアの初期化
  - ✅ 描画エンジンとステート管理の接続
  - ✅ ステートストアの基本動作テスト（状態変更の確認）
  - _Requirements: 7.4, 2.2_

  **達成条件:**

  - ✅ Zustand が正常にインストール・設定される
  - ✅ アプリケーションステートが定義される
  - ✅ 状態変更が描画に反映される
  - ✅ ステート管理テストがパスする
  - ✅ 予期しない副作用が発生しない

- [ ] 6. 入力処理システムの実装と接続

  - [ ] 6.1 座標変換レイヤーと基本入力イベント処理

    - 独立した座標変換レイヤー（CoordinateTransform）の実装
    - ビュー変換行列（ズーム・パン・回転）の管理
    - Pointer Events API を使用した入力イベント正規化関数実装
    - デバイス座標 →Canvas 座標変換の統合実装
    - 座標変換の単体テスト（各変換段階での精度検証）
    - _Requirements: 4.3, 4.4, 3.1, 3.2_

    **達成条件:**

    - ✅ CoordinateTransform レイヤーが独立して動作する
    - ✅ ビュー変換行列の計算が数学的に正確である
    - ✅ デバイス座標 →Canvas 座標変換が正確である
    - ✅ ズーム・パン状態での座標変換が正しく動作する
    - ✅ 入力処理と描画処理が同じ座標系を参照する
    - ✅ 座標変換の単体テストがパスする

  - [ ] 6.2 基本入力調整と間引き処理

    - 入力座標の頻度・近接チェックと間引き処理実装
    - 最低限の入力正規化（重複座標除去、最小移動距離フィルタ）
    - 基本的な入力バッファリング機能
    - 入力間引きの動作テスト（高頻度入力での確認）
    - _Requirements: 4.3, 4.4_

    **達成条件:**

    - ✅ 頻繁・近接すぎる入力座標が適切に間引かれる
    - ✅ 重複座標が除去される
    - ✅ 最小移動距離フィルタが動作する
    - ✅ 入力バッファリングが正常に動作する
    - ✅ 高頻度入力でも安定して動作する

  - [ ] 6.3 入力システムと描画エンジンの統合

    - リアルタイム入力から描画への完全なデータフロー実装
    - 入力イベントハンドラーとステート管理の接続
    - 実際の描画操作での動作確認（基本的な線の太さで）
    - _Requirements: 4.3, 4.4, 1.2_

    **達成条件:**

    - ✅ マウス/タッチ入力でリアルタイム描画ができる
    - ✅ 基本的な線の太さで描画される
    - ✅ 対称描画がリアルタイムで動作する
    - ✅ 入力 → ステート更新 → 描画のフローが正常に動作する
    - ✅ 実際の描画操作が期待通りに動作する

  - [ ] 6.4 筆圧とスムージング処理（高度な機能）

    - 筆圧値の検出と正規化処理実装
    - Catmull-Rom spline によるストロークスムージング関数
    - 入力遅延最小化のための最適化実装
    - スムージング関数の数学的正確性テスト（既知の入力での出力検証）
    - _Requirements: 4.1, 4.2, 4.4_

    **達成条件:**

    - ✅ 筆圧値が正しく検出・正規化される（0.0-1.0）
    - ✅ Catmull-Rom spline スムージングが動作する
    - ✅ 入力遅延が 16ms 以下に最適化される
    - ✅ スムージング関数の数学的正確性が確認される
    - ✅ 滑らかな線が描画される

- [ ] 7. ズーム・タイリングシステムの実装

  - [ ] 7.1 ズーム機能の実装

    - ズームレベル計算とビューポート変換関数
    - Canvas 座標からスクリーン座標への変換
    - ズーム中心点の維持機能
    - 座標変換関数の精度テスト（境界値での変換確認）
    - _Requirements: 3.1, 3.2, 3.6_

    **達成条件:**

    - ✅ ズームスライダーで表示倍率が変更できる（10%-200%）
    - ✅ ビューポート変換が正確に動作する
    - ✅ ズーム中心点が維持される
    - ✅ 座標変換の精度テストがパスする
    - ✅ 境界値での変換が正確である

  - [ ] 7.2 タイリング表示システム

    - フレームバッファを使用したパターンテクスチャ生成
    - タイル位置計算とビューポートカリング
    - シームレス境界処理の実装
    - タイル境界のシームレス性テスト（境界での連続性確認）
    - _Requirements: 3.3, 3.4, 3.5_

    **達成条件:**

    - ✅ ズームアウト時にタイリングパターンが表示される
    - ✅ フレームバッファテクスチャが正常に生成される
    - ✅ タイル境界がシームレスに接続される
    - ✅ ビューポートカリングが動作する
    - ✅ タイル境界の連続性テストがパスする

- [ ] 8. パフォーマンス監視システムの実装

  - [ ] 8.1 FPS 測定とメトリクス収集

    - リアルタイム FPS カウンター実装
    - フレーム時間とレンダリング時間の測定
    - メモリ使用量監視機能
    - _Requirements: 5.1, 5.2, 5.6_

    **達成条件:**

    - ✅ リアルタイム FPS カウンターが表示される
    - ✅ フレーム時間が正確に測定される
    - ✅ レンダリング時間が測定される
    - ✅ メモリ使用量が監視できる
    - ✅ 60fps 以上が維持される

  - [ ] 8.2 入力遅延測定

    - ポインターイベントから描画完了までの遅延測定
    - パフォーマンスメトリクスのログ出力機能
    - 性能劣化検出とアラート機能
    - _Requirements: 5.3, 5.5_

    **達成条件:**

    - ✅ 入力遅延が測定・表示される
    - ✅ パフォーマンスメトリクスがログ出力される
    - ✅ 性能劣化が検出される
    - ✅ アラート機能が動作する
    - ✅ 入力遅延が 16ms 以下に維持される

- [ ] 9. UI コントロールの実装

  - 基本的なズームスライダー UI 作成
  - パフォーマンスメトリクス表示 UI
  - タッチフレンドリーなコントロール実装
  - _Requirements: 6.1, 6.2, 6.3, 6.5_

  **達成条件:**

  - ✅ ズームスライダーが正常に動作する
  - ✅ パフォーマンスメトリクスが表示される
  - ✅ タッチデバイスで操作できる
  - ✅ UI が描画エリアを妨げない
  - ✅ レスポンシブデザインが適用される

- [ ] 10. 統合とテスト

  - [ ] 10.1 システム統合

    - 全コンポーネントの統合とデータフロー接続
    - エラーハンドリングとフォールバック処理
    - 初期化シーケンスの実装
    - _Requirements: 1.5, 7.4_

    **達成条件:**

    - ✅ 全コンポーネントが正常に統合される
    - ✅ データフローが正しく接続される
    - ✅ エラーハンドリングが適切に動作する
    - ✅ 初期化シーケンスが正常に実行される
    - ✅ システム全体が安定して動作する

  - [ ] 10.2 パフォーマンステスト実装

    - 自動化されたパフォーマンステストスイート
    - 異なる対称軸数での性能比較テスト
    - 長時間描画セッションでのメモリリークテスト
    - _Requirements: 1.2, 5.5, 5.6_

    **達成条件:**

    - ✅ パフォーマンステストスイートが実行される
    - ✅ 対称軸数による性能差が測定される
    - ✅ メモリリークが検出されない
    - ✅ 長時間テストで安定性が確認される
    - ✅ 性能要件（60fps）が満たされる

- [ ] 11. 最適化と仕上げ

  - WebGL 描画パイプラインの最適化
  - メモリ使用量の最適化とガベージコレクション対策
  - デバイス互換性の確認と調整
  - _Requirements: 1.4, 5.4, 6.5_

  **達成条件:**

  - ✅ 描画パイプラインが最適化される
  - ✅ メモリ使用量が最適化される
  - ✅ ガベージコレクション対策が実装される
  - ✅ 主要デバイス・ブラウザで動作確認される
  - ✅ 最終的な性能要件がすべて満たされる
